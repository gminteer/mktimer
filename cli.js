#!/usr/bin/env node
import arg from 'arg';
import process from 'node:process';
import * as fs from 'node:fs/promises';
import {promisify} from 'node:util';
import {exec as _exec} from 'node:child_process';
const exec = promisify(_exec);

let name, execstart, timespan, calendar;

async function preflight() {
  // Validate arguments exist and are plausible
  let error;

  if (!args['--name']) error = '--name missing';
  else name = args['--name'];

  if (!args['--exec']) error = '--exec missing';
  else execstart = args['--exec'];

  if (!args['--timespan'] && !args['--calendar'])
    error = 'need either --timespan or --calendar';
  if (args['--timespan'] && args['--calendar'])
    error = 'both --timespan and --calendar specified: pick one';
  if (error) {
    console.error(error);
    process.exit(-1);
  }

  // error out if there's already a systemd service
  // with the specified name
  try {
    const srvFile = `${process.env.HOME}/.config/systemd/user/${name}.service`;
    await fs.access(srvFile);
    console.error(`${srvFile} already exists! Aborting...`);
    process.exit(-1);
  } catch (error) {
    if (error.code !== 'ENOENT') {
      console.error(error.message);
      process.exit(-1);
    }
  }

  // make sure executable exists and is executable
  try {
    await fs.access(
      execstart.split(' ')[0],
      fs.constants.R_OK | fs.constants.X_OK
    );
  } catch (error) {
    console.error(error.message);
    process.exit(-1);
  }

  // let systemd-analyze validate/normalize the format
  // of the timespan/calendar given
  if (args['--timespan']) {
    try {
      const {stdout} = await exec(
        `systemd-analyze timespan '${args['--timespan']}' |\
         grep Human | cut -d ':' -f 2- | xargs`
      );
      timespan = stdout;
    } catch (error) {
      console.error(error.stderr);
      process.exit(-1);
    }
  }
  if (args['--calendar']) {
    try {
      const {stdout} = await exec(
        `systemd-analyze calendar '${args['--calendar']}' |\
         grep Normalized | cut -d ':' -f 2- | xargs`
      );
      calendar = stdout;
    } catch (error) {
      console.error(error.stderr);
      process.exit(-1);
    }
  }
}

const args = arg(
  {
    '--help': Boolean,
    '--version': Boolean,
    '-h': '--help',
    '-v': '--version',

    '--calendar': String,
    '--exec': String,
    '--name': String,
    '--timespan': String,

    '-c': '--calendar',
    '-n': '--name',
    '-x': '--exec',
    '-t': '--timespan',
  },
  {permissive: true}
);

await preflight();

const serviceContent = `#${name}.service
[Unit]
Description=Autogenerated service unit for "${name}"

[Service]
Type=oneshot
ExecStart="${execstart}"
`;

const timerContent = `#${name}.timer
[Unit]
Description=Autogenerated timer unit for "${name}"

[Timer]
${timespan ? `OnUnitActiveSec=${timespan}` : `OnCalendar=${calendar}`}\
Unit=${name}.service

[Install]
WantedBy=timers.target
`;

try {
  let fileName = `${process.env.HOME}/.config/systemd/user/${name}.service`;
  await fs.writeFile(fileName, serviceContent, {mode: 0o660});
  console.info(`${fileName} created successfully.`);
  fileName = `${process.env.HOME}/.config/systemd/user/${name}.timer`;
  await fs.writeFile(fileName, timerContent, {mode: 0o660});
  console.info(`${fileName} created successfully.`);
  // systemctl only outputs to stderr?
  const {stderr} = await exec(
    `systemctl --user enable ${name}.timer &&\
     systemctl --user start ${name}.timer`
  );
  console.info(stderr);
} catch (error) {
  console.error(error.message ? error.message : error.stderr);
  process.exit(-1);
}
